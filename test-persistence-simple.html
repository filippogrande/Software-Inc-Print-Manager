<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Persistenza Semplice</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            background: #28a745;
        }
        .danger {
            background: #dc3545;
        }
        .info {
            background: #17a2b8;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            min-height: 200px;
            overflow-y: auto;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .contracts-list {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .contract-item {
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Persistenza Semplice</h1>
        
        <div class="step">
            <h3>Step 1: Verifica Stato Iniziale</h3>
            <button onclick="checkInitialState()">Verifica Stato</button>
            <div id="initialState"></div>
        </div>

        <div class="step">
            <h3>Step 2: Salva Dati Test</h3>
            <button onclick="saveTestData()">Salva Dati</button>
            <div id="saveResult"></div>
        </div>

        <div class="step">
            <h3>Step 3: Simula Ricarica</h3>
            <button onclick="simulateReload()">Simula Ricarica</button>
            <div id="reloadResult"></div>
        </div>

        <div class="step">
            <h3>Step 4: Verifica Persistenza</h3>
            <button onclick="verifyPersistence()">Verifica Persistenza</button>
            <div id="persistenceResult"></div>
        </div>

        <div class="step">
            <h3>üóÉÔ∏è Lista Contratti Attuale</h3>
            <div id="contractsList" class="contracts-list">
                <div class="no-contracts">
                    <i class="fas fa-inbox"></i>
                    <p>Nessun contratto attivo</p>
                </div>
            </div>
        </div>

        <div class="step">
            <h3>üßπ Pulizia</h3>
            <button onclick="clearAllData()" class="danger">Cancella Tutti i Dati</button>
        </div>

        <div class="step">
            <h3>üìù Log di Debug</h3>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <!-- Carica i manager -->
    <script src="js/timeManager.js"></script>
    <script src="js/contractManager.js"></script>
    <script src="js/productionManager.js"></script>
    <script src="js/uiManager.js"></script>
    <script src="js/analysisManager.js"></script>
    <script src="js/dataManager.js"></script>
    <script src="js/settingsManager.js"></script>
    <script src="js/eventManager.js"></script>
    <script src="script.js"></script>

    <script>
        let app = null;
        const log = document.getElementById('debugLog');
        
        function logMsg(message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}\n`;
            log.textContent += entry;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        function updateContractsList() {
            const contractsDiv = document.getElementById('contractsList');
            if (!app) {
                contractsDiv.innerHTML = '<p>App non inizializzata</p>';
                return;
            }

            const contracts = app.contractManager.getContracts();
            
            if (!contracts || contracts.length === 0) {
                contractsDiv.innerHTML = `
                    <div class="no-contracts">
                        <i class="fas fa-inbox"></i>
                        <p>Nessun contratto attivo</p>
                    </div>
                `;
                return;
            }

            const contractsHtml = contracts.map(contract => `
                <div class="contract-item">
                    <strong>${contract.name}</strong><br>
                    Quantit√†: ${contract.quantity}, Scadenza: ${contract.deadline}, Priorit√†: ${contract.priority}
                </div>
            `).join('');

            contractsDiv.innerHTML = contractsHtml;
        }

        function checkInitialState() {
            logMsg('üîç Controllo stato iniziale...');
            
            try {
                // Verifica localStorage
                const data = localStorage.getItem('printingCapacityData');
                const hasData = !!data;
                
                let result = `LocalStorage: ${hasData ? 'Dati presenti' : 'Vuoto'}`;
                
                if (hasData) {
                    const parsedData = JSON.parse(data);
                    result += `\nContratti salvati: ${parsedData.contracts?.length || 0}`;
                    result += `\nData gioco: ${parsedData.gameDate || 'Non impostata'}`;
                    result += `\nCapacit√†: ${parsedData.printCapacity || 'Non impostata'}`;
                }
                
                document.getElementById('initialState').innerHTML = `<pre>${result}</pre>`;
                logMsg('‚úÖ Stato iniziale controllato');
                
            } catch (error) {
                logMsg(`‚ùå Errore controllo stato: ${error.message}`);
                document.getElementById('initialState').innerHTML = `<pre>Errore: ${error.message}</pre>`;
            }
        }

        function saveTestData() {
            logMsg('üíæ Salvataggio dati test...');
            
            try {
                // Inizializza app se non esiste
                if (!app) {
                    app = new PrintingCapacityApp();
                    logMsg('‚úÖ App inizializzata');
                }
                
                // Imposta dati di test
                app.gameDate = '2025-01';
                app.gameHour = 10;
                app.printCapacity = 1000;
                
                // Aggiungi contratti di test
                app.contractManager.clearContracts();
                
                const testContracts = [
                    { name: 'Contratto Test 1', quantity: 500, deadline: '2025-03', priority: 'normal' },
                    { name: 'Contratto Test 2', quantity: 800, deadline: '2025-04', priority: 'high' },
                    { name: 'Contratto Test 3', quantity: 300, deadline: '2025-02', priority: 'normal' }
                ];
                
                testContracts.forEach(contractData => {
                    app.contractManager.addContract(contractData);
                });
                
                logMsg(`‚úÖ Aggiunti ${testContracts.length} contratti di test`);
                
                // Salva i dati
                const result = app.saveData();
                
                if (result) {
                    logMsg('‚úÖ Dati salvati con successo');
                    document.getElementById('saveResult').innerHTML = `
                        <div style="color: green;">‚úÖ Dati salvati con successo</div>
                        <div>Contratti salvati: ${testContracts.length}</div>
                        <div>Data: ${app.gameDate}</div>
                        <div>Capacit√†: ${app.printCapacity}</div>
                    `;
                } else {
                    logMsg('‚ùå Errore nel salvataggio');
                    document.getElementById('saveResult').innerHTML = `
                        <div style="color: red;">‚ùå Errore nel salvataggio</div>
                    `;
                }
                
                updateContractsList();
                
            } catch (error) {
                logMsg(`‚ùå Errore salvataggio: ${error.message}`);
                document.getElementById('saveResult').innerHTML = `
                    <div style="color: red;">‚ùå Errore: ${error.message}</div>
                `;
            }
        }

        function simulateReload() {
            logMsg('üîÑ Simulazione ricarica pagina...');
            
            try {
                // Salva riferimenti dei dati prima della "ricarica"
                const beforeContracts = app ? app.contractManager.getContracts().length : 0;
                const beforeGameDate = app ? app.gameDate : null;
                const beforePrintCapacity = app ? app.printCapacity : null;
                
                logMsg(`Prima della ricarica: ${beforeContracts} contratti, data: ${beforeGameDate}, capacit√†: ${beforePrintCapacity}`);
                
                // Simula ricarica reinizializzando l'app
                app = null; // Distruggi l'app corrente
                app = new PrintingCapacityApp(); // Reinizializza
                
                logMsg('‚úÖ App reinizializzata');
                
                // Verifica i dati dopo la ricarica
                const afterContracts = app.contractManager.getContracts().length;
                const afterGameDate = app.gameDate;
                const afterPrintCapacity = app.printCapacity;
                
                logMsg(`Dopo la ricarica: ${afterContracts} contratti, data: ${afterGameDate}, capacit√†: ${afterPrintCapacity}`);
                
                const isSuccess = (
                    beforeContracts === afterContracts &&
                    beforeGameDate === afterGameDate &&
                    beforePrintCapacity === afterPrintCapacity
                );
                
                document.getElementById('reloadResult').innerHTML = `
                    <div style="color: ${isSuccess ? 'green' : 'red'};">
                        ${isSuccess ? '‚úÖ Ricarica riuscita' : '‚ùå Ricarica fallita'}
                    </div>
                    <div>Prima: ${beforeContracts} contratti</div>
                    <div>Dopo: ${afterContracts} contratti</div>
                    <div>Data: ${beforeGameDate} ‚Üí ${afterGameDate}</div>
                    <div>Capacit√†: ${beforePrintCapacity} ‚Üí ${afterPrintCapacity}</div>
                `;
                
                updateContractsList();
                
            } catch (error) {
                logMsg(`‚ùå Errore simulazione ricarica: ${error.message}`);
                document.getElementById('reloadResult').innerHTML = `
                    <div style="color: red;">‚ùå Errore: ${error.message}</div>
                `;
            }
        }

        function verifyPersistence() {
            logMsg('üîç Verifica persistenza dati...');
            
            try {
                // Verifica localStorage
                const localData = localStorage.getItem('printingCapacityData');
                if (!localData) {
                    throw new Error('Nessun dato trovato nel localStorage');
                }
                
                const parsedData = JSON.parse(localData);
                logMsg(`‚úÖ Dati trovati nel localStorage: ${parsedData.contracts?.length || 0} contratti`);
                
                // Verifica app
                if (!app) {
                    throw new Error('App non inizializzata');
                }
                
                const appContracts = app.contractManager.getContracts().length;
                const storageContracts = parsedData.contracts?.length || 0;
                
                const isConsistent = (appContracts === storageContracts);
                
                document.getElementById('persistenceResult').innerHTML = `
                    <div style="color: ${isConsistent ? 'green' : 'red'};">
                        ${isConsistent ? '‚úÖ Persistenza funzionante' : '‚ùå Persistenza non funzionante'}
                    </div>
                    <div>Contratti nell'app: ${appContracts}</div>
                    <div>Contratti nel localStorage: ${storageContracts}</div>
                    <div>Data salvata: ${parsedData.gameDate}</div>
                    <div>Capacit√† salvata: ${parsedData.printCapacity}</div>
                `;
                
                logMsg(isConsistent ? '‚úÖ Persistenza verificata' : '‚ùå Persistenza non funzionante');
                
            } catch (error) {
                logMsg(`‚ùå Errore verifica persistenza: ${error.message}`);
                document.getElementById('persistenceResult').innerHTML = `
                    <div style="color: red;">‚ùå Errore: ${error.message}</div>
                `;
            }
        }

        function clearAllData() {
            logMsg('üßπ Cancellazione tutti i dati...');
            
            try {
                // Cancella localStorage
                localStorage.removeItem('printingCapacityData');
                
                // Reset app
                if (app) {
                    app.contractManager.clearContracts();
                    app.gameDate = null;
                    app.gameHour = null;
                    app.printCapacity = 0;
                }
                
                // Reset UI
                document.getElementById('initialState').innerHTML = '';
                document.getElementById('saveResult').innerHTML = '';
                document.getElementById('reloadResult').innerHTML = '';
                document.getElementById('persistenceResult').innerHTML = '';
                
                updateContractsList();
                
                logMsg('‚úÖ Tutti i dati cancellati');
                
            } catch (error) {
                logMsg(`‚ùå Errore cancellazione: ${error.message}`);
            }
        }

        // Inizializza al caricamento
        window.addEventListener('load', () => {
            logMsg('üåê Pagina caricata');
            checkInitialState();
        });
    </script>
</body>
</html>

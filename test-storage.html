<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Salvataggio e Caricamento Dati</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #333;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .data-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Salvataggio e Caricamento Dati</h1>
        
        <div class="section">
            <h2>üìä Status Applicazione</h2>
            <div id="appStatus" class="status warning">‚è≥ Inizializzazione...</div>
            <button class="btn" onclick="initializeApp()">Inizializza App</button>
        </div>

        <div class="section">
            <h2>üíæ Test Salvataggio</h2>
            <button class="btn btn-success" onclick="setupAndSaveData()">1. Configura e Salva Dati</button>
            <button class="btn" onclick="checkLocalStorage()">2. Verifica localStorage</button>
            <button class="btn btn-warning" onclick="addContractAndSave()">3. Aggiungi Contratto</button>
            <button class="btn" onclick="saveCurrentState()">4. Salva Stato Corrente</button>
        </div>

        <div class="section">
            <h2>üìã Test Caricamento</h2>
            <button class="btn" onclick="loadData()">1. Carica Dati</button>
            <button class="btn" onclick="simulatePageReload()">2. Simula Ricarica Pagina</button>
            <button class="btn btn-danger" onclick="clearStorage()">3. Cancella localStorage</button>
        </div>

        <div class="section">
            <h2>üìä Stato Corrente</h2>
            <div id="currentState" class="data-display">
                <p>Nessun dato caricato</p>
            </div>
        </div>

        <div class="section">
            <h2>üîç Debug e Log</h2>
            <button class="btn" onclick="clearLog()">Pulisci Log</button>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <!-- Carica tutti i moduli JavaScript -->
    <script src="js/timeManager.js"></script>
    <script src="js/contractManager.js"></script>
    <script src="js/productionManager.js"></script>
    <script src="js/uiManager.js"></script>
    <script src="js/analysisManager.js"></script>
    <script src="js/dataManager.js"></script>
    <script src="js/settingsManager.js"></script>
    <script src="js/eventManager.js"></script>
    <script src="script.js"></script>

    <script>
        let manager = null;
        let testLog = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testLog.push(logMessage);
            document.getElementById('testLog').textContent = testLog.join('\n');
            console.log(logMessage);
        }
        
        function clearLog() {
            testLog = [];
            document.getElementById('testLog').textContent = '';
        }
        
        function updateStatus(message, type = 'warning') {
            const statusEl = document.getElementById('appStatus');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateCurrentState() {
            if (!manager) {
                document.getElementById('currentState').innerHTML = '<p>Manager non inizializzato</p>';
                return;
            }
            
            const contracts = manager.contractManager.getContracts();
            const html = `
                <h3>üìä Stato App:</h3>
                <p><strong>Data:</strong> ${manager.gameDate || 'Non configurata'}</p>
                <p><strong>Ora:</strong> ${manager.gameHour !== null ? manager.gameHour + ':00' : 'Non configurata'}</p>
                <p><strong>Capacit√†:</strong> ${manager.printCapacity || 'Non configurata'}</p>
                <p><strong>Contratti:</strong> ${contracts.length}</p>
                ${contracts.length > 0 ? `
                <h4>üìã Contratti:</h4>
                ${contracts.map((c, i) => `<div>${i+1}. ${c.name} - ${c.quantity} copie - ${c.deadline}</div>`).join('')}
                ` : ''}
            `;
            document.getElementById('currentState').innerHTML = html;
        }
        
        function initializeApp() {
            log('üöÄ Inizializzazione applicazione...');
            
            try {
                manager = new PrintingCapacityApp();
                log('‚úÖ PrintingCapacityApp inizializzata');
                updateStatus('‚úÖ Applicazione inizializzata', 'success');
                updateCurrentState();
                return true;
                
            } catch (error) {
                log(`‚ùå Errore: ${error.message}`);
                updateStatus(`‚ùå Errore: ${error.message}`, 'error');
                return false;
            }
        }
        
        function setupAndSaveData() {
            if (!manager) {
                log('‚ùå Manager non inizializzato');
                return;
            }
            
            log('‚öôÔ∏è Configurazione e salvataggio dati...');
            
            try {
                // Configura dati base
                manager.gameDate = '2025-07';
                manager.gameHour = 14;
                manager.printCapacity = 1000;
                
                log('‚úÖ Dati configurati:');
                log(`   Data: ${manager.gameDate}`);
                log(`   Ora: ${manager.gameHour}:00`);
                log(`   Capacit√†: ${manager.printCapacity}`);
                
                // Salva i dati
                const result = manager.saveData();
                log('‚úÖ Dati salvati:', JSON.stringify(result, null, 2));
                
                updateCurrentState();
                
            } catch (error) {
                log(`‚ùå Errore configurazione: ${error.message}`);
            }
        }
        
        function checkLocalStorage() {
            log('üîç Verifica localStorage...');
            
            try {
                const savedData = localStorage.getItem('printingCapacityData');
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    log('‚úÖ Dati trovati nel localStorage:');
                    log(`   Data: ${data.gameDate}`);
                    log(`   Ora: ${data.gameHour}`);
                    log(`   Capacit√†: ${data.printCapacity}`);
                    log(`   Contratti: ${data.contracts ? data.contracts.length : 0}`);
                    log(`   Ultimo salvataggio: ${data.lastSaved}`);
                } else {
                    log('‚ùå Nessun dato trovato nel localStorage');
                }
                
            } catch (error) {
                log(`‚ùå Errore lettura localStorage: ${error.message}`);
            }
        }
        
        function addContractAndSave() {
            if (!manager) {
                log('‚ùå Manager non inizializzato');
                return;
            }
            
            log('‚ûï Aggiunta contratto e salvataggio...');
            
            try {
                // Prima assicurati che ci siano le impostazioni base
                if (!manager.gameDate || !manager.printCapacity) {
                    manager.gameDate = '2025-07';
                    manager.gameHour = 14;
                    manager.printCapacity = 1000;
                    log('‚öôÔ∏è Impostazioni base configurate automaticamente');
                }
                
                const testContract = {
                    name: `Contratto Test ${Date.now()}`,
                    quantity: Math.floor(Math.random() * 1000) + 500,
                    deadline: '2025-09',
                    priority: 'normal',
                    completed: 0
                };
                
                log(`üìã Aggiunta contratto: ${testContract.name}`);
                const addedContract = manager.contractManager.addContract(testContract);
                log(`‚úÖ Contratto aggiunto con ID: ${addedContract.id}`);
                
                // Salva esplicitamente
                const result = manager.saveData();
                log('üíæ Dati salvati dopo aggiunta contratto');
                
                updateCurrentState();
                
            } catch (error) {
                log(`‚ùå Errore aggiunta contratto: ${error.message}`);
            }
        }
        
        function saveCurrentState() {
            if (!manager) {
                log('‚ùå Manager non inizializzato');
                return;
            }
            
            log('üíæ Salvataggio stato corrente...');
            
            try {
                const result = manager.saveData();
                log('‚úÖ Stato salvato con successo');
                checkLocalStorage();
                
            } catch (error) {
                log(`‚ùå Errore salvataggio: ${error.message}`);
            }
        }
        
        function loadData() {
            if (!manager) {
                log('‚ùå Manager non inizializzato');
                return;
            }
            
            log('üìã Caricamento dati...');
            
            try {
                // Prima pulisci lo stato corrente
                manager.gameDate = null;
                manager.gameHour = null;
                manager.printCapacity = 0;
                manager.contractManager.clearContracts();
                
                log('üßπ Stato pulito, caricamento dati salvati...');
                
                // Carica i dati
                manager.loadData();
                
                log('‚úÖ Dati caricati:');
                log(`   Data: ${manager.gameDate}`);
                log(`   Ora: ${manager.gameHour}`);
                log(`   Capacit√†: ${manager.printCapacity}`);
                
                const contracts = manager.contractManager.getContracts();
                log(`   Contratti caricati: ${contracts.length}`);
                
                contracts.forEach((contract, index) => {
                    log(`     ${index + 1}. ${contract.name} - ${contract.quantity} copie`);
                });
                
                updateCurrentState();
                
            } catch (error) {
                log(`‚ùå Errore caricamento: ${error.message}`);
            }
        }
        
        function simulatePageReload() {
            log('üîÑ Simulazione ricarica pagina...');
            
            // Salva lo stato del localStorage prima della simulazione
            checkLocalStorage();
            
            // Distruggi l'istanza corrente
            manager = null;
            updateStatus('‚è≥ Simulazione ricarica...', 'warning');
            updateCurrentState();
            
            setTimeout(() => {
                log('üöÄ Ricostruzione app dopo "ricarica"...');
                
                // Ricrea l'app
                initializeApp();
                
                setTimeout(() => {
                    log('üìã Verifica se i dati sono stati caricati automaticamente...');
                    
                    const contracts = manager.contractManager.getContracts();
                    log(`üìä Contratti dopo ricarica: ${contracts.length}`);
                    
                    if (contracts.length > 0) {
                        log('‚úÖ Dati caricati correttamente dopo ricarica');
                        updateStatus('‚úÖ Ricarica simulata - Dati preservati', 'success');
                    } else {
                        log('‚ùå Dati NON caricati dopo ricarica');
                        updateStatus('‚ùå Ricarica simulata - Dati persi', 'error');
                    }
                    
                    updateCurrentState();
                }, 500);
                
            }, 1000);
        }
        
        function clearStorage() {
            log('üóëÔ∏è Cancellazione localStorage...');
            
            try {
                localStorage.removeItem('printingCapacityData');
                log('‚úÖ localStorage cancellato');
                
                // Aggiorna stato
                if (manager) {
                    updateCurrentState();
                }
                
            } catch (error) {
                log(`‚ùå Errore cancellazione: ${error.message}`);
            }
        }
        
        // Inizializzazione automatica
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Pagina caricata');
            
            setTimeout(() => {
                initializeApp();
            }, 500);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Finale - Capacit√† Oraria</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        .button:hover {
            background-color: #2980b9;
        }
        .results {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin: 10px 0;
        }
        .success {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 10px;
            margin: 10px 0;
        }
        .error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Finale - Capacit√† Oraria</h1>
        
        <div class="info">
            <strong>Obiettivo:</strong> Verificare che la capacit√† mostrata sia corretta quando consideriamo l'ora del giorno
        </div>
        
        <button class="button" onclick="runTest()">‚ñ∂Ô∏è Esegui Test</button>
        <button class="button" onclick="clearResults()">üßπ Pulisci Risultati</button>
        
        <div id="results" class="results"></div>
    </div>

    <script type="module">
        import { PrintingCapacityApp } from './script.js';
        
        let app;
        
        // Inizializza l'app
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                app = new PrintingCapacityApp();
                await app.init();
                
                // Imposta i dati di test
                app.timeManager.setGameDate('1999-01-01');
                app.settingsManager.updateSettings({ printCapacity: 168000 });
                
                // Aggiungi il contratto di test
                const testContract = {
                    id: 'snifferpro',
                    name: 'Snifferpro',
                    quantity: 298623,
                    deadline: '1999-03-31',
                    status: 'active',
                    completed: 0,
                    priority: 'normal'
                };
                
                app.contractManager.setContracts([testContract]);
                
                console.log('‚úÖ App inizializzata per test');
                
                // Mostra info iniziale
                log('üöÄ App inizializzata con successo!');
                log('üìÖ Data gioco: 1999-01-01');
                log('üñ®Ô∏è Capacit√†: 168,000 unit√†/mese');
                log('üìã Contratto: Snifferpro - 298,623 unit√† entro marzo 1999');
                log('===============================================\n');
                
            } catch (error) {
                console.error('‚ùå Errore durante l\'inizializzazione:', error);
                log('‚ùå Errore: ' + error.message);
            }
        });
        
        function log(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.textContent += message + '\n';
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        window.clearResults = function() {
            document.getElementById('results').textContent = '';
        };
        
        window.runTest = function() {
            log('üïê INIZIO TEST - Ora simulata: 9:00');
            log('==================================');
            
            const gameHour = 9;
            const contracts = app.contractManager.getContracts();
            const gameDate = app.timeManager.getGameDate();
            const settings = app.settingsManager.getSettings();
            const printCapacity = settings.printCapacity;
            
            log(`üìä Parametri test:`);
            log(`   - Data gioco: ${gameDate}`);
            log(`   - Ora simulata: ${gameHour}:00`);
            log(`   - Capacit√† originale: ${printCapacity.toLocaleString()}`);
            log(`   - Contratti attivi: ${contracts.length}`);
            log('');
            
            // Calcola la capacit√† attesa
            const dailyProduction = printCapacity / 30;
            const productionLostToday = (dailyProduction * gameHour) / 24;
            const expectedCapacity = Math.floor(printCapacity - productionLostToday);
            const reductionPercent = (((printCapacity - expectedCapacity) / printCapacity) * 100).toFixed(1);
            
            log(`üßÆ Calcolo capacit√† ridotta:`);
            log(`   - Produzione giornaliera: ${dailyProduction.toLocaleString()}`);
            log(`   - Ore passate oggi: ${gameHour}`);
            log(`   - Produzione persa oggi: ${productionLostToday.toLocaleString()}`);
            log(`   - Capacit√† attesa: ${expectedCapacity.toLocaleString()}`);
            log(`   - Riduzione: ${reductionPercent}%`);
            log('');
            
            // Esegui l'analisi
            log('üîç Esecuzione analisi...');
            const analysis = app.analysisManager.calculateAnalysis(
                contracts, 
                gameDate, 
                printCapacity, 
                app.timeManager, 
                gameHour
            );
            
            log('üìä Risultati analisi:');
            log(`   - Capacit√† usata: ${analysis.capacityUsage}%`);
            log(`   - Mesi necessari: ${analysis.monthsNeeded}`);
            log(`   - Fattibilit√†: ${analysis.feasible ? 'S√å' : 'NO'}`);
            log('');
            
            // Esegui il calcolo della distribuzione mensile
            log('üìÖ Calcolo distribuzione mensile...');
            const monthlySchedule = app.analysisManager.calculateMonthlySchedule(
                contracts.filter(c => c.status === 'active'),
                gameDate,
                printCapacity,
                app.timeManager,
                gameHour
            );
            
            log('üìà Distribuzione mensile:');
            monthlySchedule.forEach((month, index) => {
                const status = month.feasible ? '‚úÖ' : '‚ùå';
                log(`   ${status} ${month.month}: ${month.production.toLocaleString()}/${month.capacity.toLocaleString()} (${month.load}%)`);
                
                if (index === 0) {
                    // Verifica se la capacit√† del primo mese √® corretta
                    const capacityCorrect = month.capacity === expectedCapacity;
                    log(`      üëÜ Primo mese - Capacit√† corretta: ${capacityCorrect ? '‚úÖ S√å' : '‚ùå NO'}`);
                    if (!capacityCorrect) {
                        log(`      ‚ö†Ô∏è  Attesa: ${expectedCapacity.toLocaleString()}, Ottenuta: ${month.capacity.toLocaleString()}`);
                    }
                }
            });
            
            log('');
            
            // Test di fattibilit√† del contratto
            log('üéØ Test fattibilit√† contratto...');
            const contractFeasibility = app.analysisManager.calculateContractFeasibility(
                contracts[0],
                gameDate,
                printCapacity,
                [],
                app.timeManager,
                gameHour
            );
            
            log('üìã Risultato fattibilit√†:');
            log(`   - Nome: ${contractFeasibility.name}`);
            log(`   - Quantit√†: ${contractFeasibility.quantity.toLocaleString()}`);
            log(`   - Fattibile: ${contractFeasibility.feasible ? 'S√å' : 'NO'}`);
            log(`   - Mesi disponibili: ${contractFeasibility.monthsAvailable}`);
            log(`   - Completamento previsto: ${contractFeasibility.completionDate || 'N/A'}`);
            log('');
            
            // Verifica finale
            log('üèÅ VERIFICA FINALE:');
            log('==================');
            
            const firstMonth = monthlySchedule[0];
            const testResults = {
                capacityReduced: firstMonth.capacity < printCapacity,
                capacityCorrect: firstMonth.capacity === expectedCapacity,
                productionRealistic: firstMonth.production <= firstMonth.capacity,
                loadCalculated: Math.abs(firstMonth.load - (firstMonth.production / firstMonth.capacity * 100)) < 0.1
            };
            
            Object.entries(testResults).forEach(([test, result]) => {
                const status = result ? '‚úÖ' : '‚ùå';
                log(`${status} ${test}: ${result}`);
            });
            
            const allTestsPassed = Object.values(testResults).every(r => r);
            log('');
            log(`üéâ RISULTATO FINALE: ${allTestsPassed ? '‚úÖ TUTTI I TEST SUPERATI' : '‚ùå ALCUNI TEST FALLITI'}`);
            log('');
            log('Test completato: ' + new Date().toLocaleTimeString());
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Correzione Capacit√† Oraria</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h2 {
            color: #2c3e50;
            margin-top: 0;
        }
        .button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #2980b9;
        }
        .results {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin: 10px 0;
        }
        .success {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 10px;
            margin: 10px 0;
        }
        .error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Correzione Capacit√† Oraria</h1>
        
        <div class="info">
            <strong>Obiettivo:</strong> Verificare che la capacit√† mostrata nei calcoli sia quella ridotta quando si considera l'ora corrente.
        </div>
        
        <div class="test-section">
            <h2>Test 1: Capacit√† alle 9:00 (37.5% del giorno passato)</h2>
            <button class="button" onclick="testCapacityAt9AM()">Testa alle 9:00</button>
            <div id="results-9am" class="results"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 2: Capacit√† alle 12:00 (50% del giorno passato)</h2>
            <button class="button" onclick="testCapacityAt12PM()">Testa alle 12:00</button>
            <div id="results-12pm" class="results"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 3: Capacit√† alle 18:00 (75% del giorno passato)</h2>
            <button class="button" onclick="testCapacityAt6PM()">Testa alle 18:00</button>
            <div id="results-6pm" class="results"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 4: Capacit√† alle 0:00 (inizio giornata)</h2>
            <button class="button" onclick="testCapacityAt12AM()">Testa alle 0:00</button>
            <div id="results-12am" class="results"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 5: Confronto dettagliato</h2>
            <button class="button" onclick="runDetailedComparison()">Confronta ore diverse</button>
            <div id="results-comparison" class="results"></div>
        </div>
    </div>

    <script type="module">
        import { PrintingCapacityApp } from './script.js';
        
        let app;
        
        // Inizializza l'app
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                app = new PrintingCapacityApp();
                await app.init();
                
                // Aggiungi contratti di test
                const testContracts = [
                    {
                        id: 'test1',
                        name: 'Contratto Test 1',
                        quantity: 100000,
                        deadline: '2024-02-28',
                        status: 'active',
                        completed: 0,
                        priority: 'high'
                    },
                    {
                        id: 'test2',
                        name: 'Contratto Test 2',
                        quantity: 150000,
                        deadline: '2024-03-31',
                        status: 'active',
                        completed: 0,
                        priority: 'medium'
                    }
                ];
                
                app.contractManager.setContracts(testContracts);
                
                console.log('‚úÖ App inizializzata con successo');
                console.log('üìä Contratti di test caricati:', testContracts.length);
                
                // Imposta una data fissa per i test
                app.timeManager.setGameDate('2024-01-15');
                
                // Test di capacit√† impostata
                const printCapacity = 200000;
                app.settingsManager.updateSettings({ printCapacity });
                
                displayInfo('App inizializzata con successo!', 'success');
                
            } catch (error) {
                console.error('‚ùå Errore durante l\'inizializzazione:', error);
                displayInfo('Errore durante l\'inizializzazione: ' + error.message, 'error');
            }
        });
        
        function displayInfo(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            document.body.insertBefore(div, document.body.firstChild);
            
            setTimeout(() => {
                div.remove();
            }, 5000);
        }
        
        window.testCapacityAt9AM = function() {
            testCapacityAtHour(9, 'results-9am');
        };
        
        window.testCapacityAt12PM = function() {
            testCapacityAtHour(12, 'results-12pm');
        };
        
        window.testCapacityAt6PM = function() {
            testCapacityAtHour(18, 'results-6pm');
        };
        
        window.testCapacityAt12AM = function() {
            testCapacityAtHour(0, 'results-12am');
        };
        
        function testCapacityAtHour(hour, resultElementId) {
            console.log(`\nüïê === TEST CAPACIT√Ä ALLE ${hour}:00 ===`);
            
            const contracts = app.contractManager.getContracts();
            const gameDate = app.timeManager.getGameDate();
            const printCapacity = app.settingsManager.getSettings().printCapacity;
            
            // Calcola analisi con ora specifica
            const analysis = app.analysisManager.calculateAnalysis(
                contracts, 
                gameDate, 
                printCapacity, 
                app.timeManager, 
                hour
            );
            
            // Calcola anche la distribuzione mensile
            const monthlySchedule = app.analysisManager.calculateMonthlySchedule(
                contracts.filter(c => c.status === 'active'), 
                gameDate, 
                printCapacity, 
                app.timeManager, 
                hour
            );
            
            // Calcola la capacit√† attesa
            const dailyProduction = printCapacity / 30;
            const productionLostToday = (dailyProduction * hour) / 24;
            const expectedCapacity = Math.floor(printCapacity - productionLostToday);
            const reductionPercent = (((printCapacity - expectedCapacity) / printCapacity) * 100).toFixed(1);
            
            let result = `ANALISI PER LE ${hour}:00\n`;
            result += `==================\n\n`;
            result += `üè≠ Capacit√† originale: ${printCapacity.toLocaleString()}\n`;
            result += `üìâ Capacit√† attesa: ${expectedCapacity.toLocaleString()}\n`;
            result += `üìä Riduzione attesa: ${(printCapacity - expectedCapacity).toLocaleString()} (-${reductionPercent}%)\n\n`;
            
            result += `RISULTATI ANALISI:\n`;
            result += `- Capacit√† usata nei calcoli: ${analysis.capacityUsage}%\n`;
            result += `- Mesi necessari: ${analysis.monthsNeeded}\n`;
            result += `- Fattibilit√†: ${analysis.feasible ? 'S√å' : 'NO'}\n\n`;
            
            if (monthlySchedule.length > 0) {
                result += `DISTRIBUZIONE MENSILE:\n`;
                monthlySchedule.forEach((month, index) => {
                    result += `${month.month}: ${month.load.toLocaleString()}/${month.capacity.toLocaleString()} (${month.percentage}%)\n`;
                    if (index === 0) {
                        result += `  üëÜ Primo mese - Capacit√† ridotta: ${month.capacity === expectedCapacity ? 'S√å' : 'NO'}\n`;
                    }
                });
            }
            
            result += `\n‚úÖ Test completato alle ${new Date().toLocaleTimeString()}`;
            
            document.getElementById(resultElementId).textContent = result;
        }
        
        window.runDetailedComparison = function() {
            console.log('\nüîç === CONFRONTO DETTAGLIATO ===');
            
            const hours = [0, 6, 9, 12, 15, 18, 21];
            const printCapacity = app.settingsManager.getSettings().printCapacity;
            const contracts = app.contractManager.getContracts();
            const gameDate = app.timeManager.getGameDate();
            
            let result = 'CONFRONTO CAPACIT√Ä PER ORE DIVERSE\n';
            result += '===================================\n\n';
            
            result += 'Ora\t| Capacit√†\t| Riduzione\t| Uso%\t| Mesi\n';
            result += '----\t| --------\t| ---------\t| ----\t| ----\n';
            
            hours.forEach(hour => {
                const analysis = app.analysisManager.calculateAnalysis(
                    contracts, gameDate, printCapacity, app.timeManager, hour
                );
                
                const dailyProduction = printCapacity / 30;
                const productionLostToday = (dailyProduction * hour) / 24;
                const expectedCapacity = Math.floor(printCapacity - productionLostToday);
                const reductionPercent = (((printCapacity - expectedCapacity) / printCapacity) * 100).toFixed(1);
                
                result += `${hour}:00\t| ${expectedCapacity.toLocaleString()}\t| -${reductionPercent}%\t| ${analysis.capacityUsage}%\t| ${analysis.monthsNeeded}\n`;
            });
            
            result += '\nüìä Capacit√† originale: ' + printCapacity.toLocaleString();
            result += '\nüéØ Quantit√† totale contratti: ' + contracts.filter(c => c.status === 'active').reduce((sum, c) => sum + (c.quantity - c.completed), 0).toLocaleString();
            
            document.getElementById('results-comparison').textContent = result;
        };
    </script>
</body>
</html>
